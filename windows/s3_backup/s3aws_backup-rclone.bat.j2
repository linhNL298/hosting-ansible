@echo off
chcp 65001 >nul
setlocal enabledelayedexpansion

:: Äá»‹nh nghÄ©a biáº¿n cáº¥u hÃ¬nh
set "RCLONE_EXE=C:\scripts\rclone-v1.71.1-windows-amd64\rclone.exe"
set "LOG_DIR=C:\scripts\Log_rclone"
set "DATE=%date:~10,4%-%date:~4,2%-%date:~7,2%"
set "LOGFILE=%LOG_DIR%\rclone_backup_%DATE%.log"

set "REMOTE=hosting"
set "SRC1=C:\Program Files (x86)\Plesk\Backup"
set "DST1=%REMOTE%:webhosting/weekly/{{inventory_hostname}}/backup"
set "SRC2=C:\Program Files (x86)\Plesk\MySQL\Backup"
set "DST2=%REMOTE%:webhosting/weekly/{{inventory_hostname}}/psa_backup"

:: Táº¡o thÆ° má»¥c log náº¿u chÆ°a cÃ³
if not exist "%LOG_DIR%" mkdir "%LOG_DIR%"

:: Ghi thÃ´ng tin báº¯t Ä‘áº§u vÃ o log
echo -------------------------------------------------- >> "%LOGFILE%"
echo [!DATE! !TIME!] ðŸš€ Báº®T Äáº¦U SAO LÆ¯U : !SRC! â†’ !DST! >> "%LOGFILE%"
echo -------------------------------------------------- >> "%LOGFILE%"

:: Cháº¡y sao lÆ°u tá»«ng thÆ° má»¥c
call :DoSync "%SRC1%" "%DST1%"
call :DoSync "%SRC2%" "%DST2%"

:: Ghi thÃ´ng tin hoÃ n táº¥t vÃ o log
echo ================================================== >> "%LOGFILE%"
echo [%DATE% %TIME%] âœ… SAO LÆ¯U HOÃ€N Táº¤T >> "%LOGFILE%"
echo ================================================== >> "%LOGFILE%"
goto :eof

:DoSync
setlocal enabledelayedexpansion
set "SRC=%~1"
set "DST=%~2"

"%RCLONE_EXE%" sync "!SRC!" "!DST!" ^
  --s3-upload-concurrency 8 ^
  --transfers 16 ^
  --checkers 8 ^
  --s3-chunk-size 128M ^
  --ignore-errors ^
  --retries 5 ^
  --low-level-retries 10 ^
  --log-level INFO ^
  --stats 60s ^
  --create-empty-src-dirs ^
  --progress >> "%LOGFILE%" 2>&1

if !errorlevel! == 0 (
    echo [!DATE! !TIME!] âœ… HOÃ€N THÃ€NH: !SRC! â†’ !DST! >> "%LOGFILE%"
) else (
    echo [!DATE! !TIME!] âŒ Lá»–I: !SRC! â†’ !DST! (ErrorLevel=!errorlevel!) >> "%LOGFILE%"
)

endlocal & (
    echo. >> "%LOGFILE%"
)
goto :eof
